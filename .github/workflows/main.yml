name: ✅ RDP + Tailscale (Portable Fix)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest

    steps:
      - name: 🧱 Setup RDP User
        shell: pwsh
        run: |
          Write-Host "👤 Creating RDP user..."
          $chars = (48..57)+(65..90)+(97..122)+(33..47)
          $pw = -join (1..14 | ForEach-Object {[char]($chars | Get-Random)})  # <= Max 14 chars to avoid NTLM issue
          $username = "rdpuser"
          Write-Host "=== RDP CREDENTIALS ==="
          Write-Host "USERNAME: $username"
          Write-Host "PASSWORD: $pw"
          Write-Host "======================="
          $securePw = ConvertTo-SecureString $pw -AsPlainText -Force
          try {
            net user $username $pw /add
          } catch {
            Write-Host "User already exists, updating password..."
            net user $username $pw
          }
          net localgroup "Remote Desktop Users" $username /add
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: 🌐 Download and Connect to Tailscale (Portable)
        shell: pwsh
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          Write-Host "📦 Downloading Tailscale Portable..."
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-ipn-setup.exe" -OutFile "$env:TEMP\tailscale.exe" -UseBasicParsing

          $tailscaleExe = "$env:TEMP\tailscale.exe"
          if (-Not (Test-Path $tailscaleExe)) {
            throw "❌ Failed to download Tailscale portable client!"
          }

          Write-Host "🔗 Connecting to Tailscale..."
          & $tailscaleExe up --authkey $env:TAILSCALE_AUTHKEY --hostname GitHubRDP --accept-dns=false --accept-routes=true

          Write-Host "🌐 Checking Tailscale status..."
          & $tailscaleExe status

      - name: ✅ Summary
        run: |
          Write-Host "✅ RDP user created and Tailscale connected!"
          Write-Host "Use your Tailscale IP to connect via RDP."
