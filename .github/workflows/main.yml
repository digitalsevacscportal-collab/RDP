name: ‚úÖ RDP + Tailscale (Portable Client, Safe Version)

on:
  workflow_dispatch:

jobs:
  rdp-tailscale:
    runs-on: windows-latest

    steps:
      - name: üß± Create RDP User
        shell: pwsh
        run: |
          Write-Host "üë§ Creating RDP user..."
          $chars = (48..57)+(65..90)+(97..122)+(33..47)
          $pw = -join (1..14 | ForEach-Object {[char]($chars | Get-Random)})
          $username = "rdpuser"

          Write-Host "=== RDP CREDENTIALS ==="
          Write-Host "USERNAME: $username"
          Write-Host "PASSWORD: $pw"
          Write-Host "======================="

          $securePw = ConvertTo-SecureString $pw -AsPlainText -Force
          try { net user $username $pw /add } catch { net user $username $pw }
          net localgroup "Remote Desktop Users" $username /add
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: üåê Connect to Tailscale (Portable Mode)
        shell: pwsh
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          Write-Host "üì¶ Downloading portable Tailscale client..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-ipn-setup.exe"
          $tailscale = "$env:TEMP\tailscale.exe"
          Invoke-WebRequest -Uri $url -OutFile $tailscale -UseBasicParsing

          if (-Not (Test-Path $tailscale)) {
            throw "‚ùå Download failed!"
          }

          Write-Host "üîó Starting Tailscale (user mode)..."
          & $tailscale /quiet /norestart

          Start-Sleep -Seconds 5

          Write-Host "üîë Logging into Tailscale..."
          & $tailscale up --authkey $env:TAILSCALE_AUTHKEY --hostname GitHubRDP --accept-dns=false --accept-routes=true

          Write-Host "üåê Tailscale status:"
          & $tailscale status

      - name: ‚úÖ Done
        run: |
          Write-Host "‚úÖ All set!"
          Write-Host "Use Tailscale admin panel to get this runner's IP."
          Write-Host "RDP credentials shown above ‚¨ÜÔ∏è"
