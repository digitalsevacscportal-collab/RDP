name: ‚úÖ RDP + Tailscale Portable (GitHub Runner Safe)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest

    steps:
      - name: üß± Create RDP user
        shell: pwsh
        run: |
          Write-Host "üë§ Creating RDP user..."
          $chars = (48..57)+(65..90)+(97..122)+(33..47)
          $pw = -join (1..14 | ForEach-Object {[char]($chars | Get-Random)}) # max 14 chars
          $username = "rdpuser"

          Write-Host "=== RDP CREDENTIALS ==="
          Write-Host "USERNAME: $username"
          Write-Host "PASSWORD: $pw"
          Write-Host "======================="

          $securePw = ConvertTo-SecureString $pw -AsPlainText -Force
          try {
            net user $username $pw /add
          } catch {
            Write-Host "User may exist ‚Äî resetting password..."
            net user $username $pw
          }
          net localgroup "Remote Desktop Users" $username /add
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: üåê Connect to Tailscale (Portable)
        shell: pwsh
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          Write-Host "üì¶ Downloading portable Tailscale..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-ipn-setup.exe"
          $zipPath = "$env:TEMP\tailscale-portable.exe"
          Invoke-WebRequest -Uri $url -OutFile $zipPath -UseBasicParsing
          
          Write-Host "üîó Starting Tailscale daemon..."
          Start-Process -FilePath $zipPath -ArgumentList "service" -NoNewWindow
          Start-Sleep -Seconds 5

          Write-Host "üîë Authenticating..."
          & $zipPath up --authkey $env:TAILSCALE_AUTHKEY --hostname GitHubRDP --accept-routes --accept-dns=false

          Write-Host "üåê Status:"
          & $zipPath status

      - name: ‚úÖ Summary
        run: |
          Write-Host "‚úÖ All done!"
          Write-Host "Check Tailscale admin panel ‚Äî device 'GitHubRDP' should be online."
          Write-Host "Use above credentials to RDP into its Tailscale IP."
