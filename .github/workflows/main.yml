name: ‚úÖ Cloud RDP via Ngrok

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: 1Ô∏è‚É£ Setup Environment
      run: |
        Write-Host "Initializing environment..."

    - name: 2Ô∏è‚É£ Enable RDP and Create User
      run: |
        Write-Host "Creating RDP user..."
        $username = "rdpuser"
        $password = -join ((33..126) | Get-Random -Count 12 | % {[char]$_})
        net user $username $password /add
        net localgroup administrators $username /add
        reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 1
        Write-Host "=== RDP CREDENTIALS ==="
        Write-Host "USERNAME: $username"
        Write-Host "PASSWORD: $password"
        Write-Host "======================="

    - name: 3Ô∏è‚É£ Install Ngrok
      run: |
        Write-Host "Downloading Ngrok..."
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip -DestinationPath $env:USERPROFILE\ngrok

    - name: 4Ô∏è‚É£ Connect Ngrok Tunnel (RDP 3389)
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        Write-Host "Starting Ngrok tunnel..."
        $env:PATH += ";$env:USERPROFILE\ngrok"
        Start-Process "$env:USERPROFILE\ngrok\ngrok.exe" "authtoken $env:NGROK_AUTH_TOKEN" -NoNewWindow -Wait
        Start-Process "$env:USERPROFILE\ngrok\ngrok.exe" "tcp 3389" -NoNewWindow
        Start-Sleep -Seconds 10
        $tunnel = (Invoke-WebRequest -Uri "http://127.0.0.1:4040/api/tunnels").Content | ConvertFrom-Json
        $publicUrl = $tunnel.tunnels.public_url
        Write-Host "üåê Your RDP Address (via Ngrok): $publicUrl"

    - name: 5Ô∏è‚É£ Keep Alive (Prevent job timeout)
      run: |
        Write-Host "Maintaining RDP session..."
        for ($i=0; $i -lt 360; $i++) {
          Write-Host "RDP active for $i minutes..."
          Start-Sleep -Seconds 60
        }
