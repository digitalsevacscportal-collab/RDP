name: ‚úÖ RDP + Tailscale Setup

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------
      # 1Ô∏è‚É£ Generate Random Credentials
      # -------------------------------------------------------
      - name: Create RDP user and print credentials
        shell: pwsh
        run: |
          # Generate a strong random password
          $chars = (48..57) + (65..90) + (97..122) + (33..47)
          $pw = -join (1..16 | ForEach-Object { [char]($chars | Get-Random) })
          $username = "rdpuser"

          Write-Host "=== RDP CREDENTIALS ==="
          Write-Host "USERNAME: $username"
          Write-Host "PASSWORD: $pw"
          Write-Host "======================="

          # Create user (optional)
          net user $username $pw /add
          net localgroup "Remote Desktop Users" $username /add

          # Save for later steps
          echo "USERNAME=$username" >> $env:GITHUB_ENV
          echo "PASSWORD=$pw" >> $env:GITHUB_ENV

      # -------------------------------------------------------
      # 2Ô∏è‚É£ Enable RDP & Firewall Rules
      # -------------------------------------------------------
      - name: Enable Remote Desktop
        shell: pwsh
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "‚úÖ RDP access enabled successfully!"

      # -------------------------------------------------------
      # 3Ô∏è‚É£ Install and Connect Tailscale
      # -------------------------------------------------------
      - name: Install and Connect to Tailscale
        shell: pwsh
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          Write-Host "üì¶ Installing Tailscale..."
          msiexec /i https://pkgs.tailscale.com/stable/tailscale-setup-latest.msi /qn

          Write-Host "üîó Connecting to Tailscale..."
          Start-Process -FilePath "C:\Program Files\Tailscale\tailscale.exe" -ArgumentList "up --authkey $env:TAILSCALE_AUTHKEY --hostname GitHubRDP --accept-routes" -NoNewWindow -Wait

          Write-Host "üåê Checking Tailscale status..."
          & "C:\Program Files\Tailscale\tailscale.exe" status

      # -------------------------------------------------------
      # 4Ô∏è‚É£ Show Access Info
      # -------------------------------------------------------
      - name: Show connection details
        shell: pwsh
        run: |
          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4
          Write-Host "=============================="
          Write-Host "üéØ Connect via RDP at: $ip"
          Write-Host "üë§ Username: $env:USERNAME"
          Write-Host "üîë Password: $env:PASSWORD"
          Write-Host "=============================="
          Write-Host "‚ö†Ô∏è Tip: Use Tailscale IP above in your RDP client."
