name: ‚úÖ RDP + Tailscale (Portable ZIP Version)

on:
  workflow_dispatch:

jobs:
  rdp-tailscale:
    runs-on: windows-latest

    steps:
      - name: üß± Create RDP User
        shell: pwsh
        run: |
          Write-Host "üë§ Creating RDP user..."
          $chars = (48..57)+(65..90)+(97..122)+(33..47)
          $pw = -join (1..14 | ForEach-Object {[char]($chars | Get-Random)})
          $username = "rdpuser"

          Write-Host "=== RDP CREDENTIALS ==="
          Write-Host "USERNAME: $username"
          Write-Host "PASSWORD: $pw"
          Write-Host "======================="

          $securePw = ConvertTo-SecureString $pw -AsPlainText -Force
          try { net user $username $pw /add } catch { net user $username $pw }
          net localgroup "Remote Desktop Users" $username /add
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: üåê Connect to Tailscale (Portable ZIP)
        shell: pwsh
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          Write-Host "üì¶ Downloading portable Tailscale ZIP..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-windows-amd64.zip"
          $zipPath = "$env:TEMP\tailscale.zip"
          $extractPath = "$env:TEMP\tailscale"
          Invoke-WebRequest -Uri $url -OutFile $zipPath -UseBasicParsing

          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
          $tailscaleExe = Get-ChildItem -Path $extractPath -Filter "tailscale.exe" -Recurse | Select-Object -First 1 | ForEach-Object { $_.FullName }

          if (-Not (Test-Path $tailscaleExe)) {
            throw "‚ùå tailscale.exe not found after extraction!"
          }

          Write-Host "üîó Connecting to Tailscale..."
          & $tailscaleExe up --authkey $env:TAILSCALE_AUTHKEY --hostname GitHubRDP --accept-dns=false --accept-routes=true

          Write-Host "üåê Connection Status:"
          & $tailscaleExe status

      - name: ‚úÖ Done
        run: |
          Write-Host "‚úÖ Setup complete!"
          Write-Host "RDP credentials printed above."
          Write-Host "Tailscale device 'GitHubRDP' should now appear online."
